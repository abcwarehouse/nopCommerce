@model ProductDetailsModel
@{
    Html.AddScriptParts(ResourceLocation.Footer, "~/lib_npm/magnific-popup/jquery.magnific-popup.min.js");
    Html.AddCssFileParts("~/lib_npm/magnific-popup/magnific-popup.css");
}

<div class="gallery">
    @await Component.InvokeAsync("Widget", new { widgetZone = PublicWidgetZones.ProductDetailsBeforePictures, additionalData = Model })

    <div class="picture">
        <!-- Main product image always wrapped in anchor for fullscreen popup -->
        <a href="@(string.IsNullOrEmpty(Model.DefaultPictureModel?.FullSizeImageUrl) 
                    ? Model.DefaultPictureModel?.ImageUrl 
                    : Model.DefaultPictureModel?.FullSizeImageUrl)"
           title="@Model.DefaultPictureModel?.Title"
           id="main-product-img-lightbox-anchor-@Model.Id">
            <img id="main-product-img-@Model.Id"
                 src="@Model.DefaultPictureModel?.ImageUrl"
                 alt="@Model.DefaultPictureModel?.AlternateText"
                 title="@Model.DefaultPictureModel?.Title" />
        </a>
    </div>

    @* Thumbnails section *@
    @if (Model.PictureModels.Count > 1)
    {
        <div class="picture-thumbs">
            @foreach (var picture in Model.PictureModels)
            {
                var thumbFull = string.IsNullOrEmpty(picture.FullSizeImageUrl) ? picture.ImageUrl : picture.FullSizeImageUrl;
                <a class="thumb-item"
                   href="@thumbFull"
                   title="@picture.Title">
                    <img src="@picture.ThumbImageUrl"
                         alt="@picture.AlternateText"
                         title="@picture.Title"
                         data-defaultsize="@picture.ImageUrl"
                         data-fullsize="@thumbFull" />
                </a>
            }
        </div>
    }

    @await Component.InvokeAsync("Widget", new { widgetZone = PublicWidgetZones.ProductDetailsAfterPictures, additionalData = Model })
</div>

<script asp-location="Footer">
    (function ($) {
        $(function () {
            var anchorSel = '#main-product-img-lightbox-anchor-@Model.Id';

            // Initialize popup on the main image anchor
            $(anchorSel).magnificPopup({
                type: 'image',
                closeOnContentClick: true,
                mainClass: 'mfp-img-mobile',
                image: { verticalFit: true }
            });

            // B: Explicitly open popup on click (guards against theme handlers swallowing the click)
            $(document).on('click', anchorSel, function (e) {
                e.preventDefault();
                $(this).magnificPopup('open');
            });

            // Thumbnails gallery popup
            $('.picture-thumbs').magnificPopup({
                type: 'image',
                delegate: 'a',
                gallery: { enabled: true }
            });

            // Swap main image when a thumbnail is clicked
            $('.thumb-item > img').on('click', function () {
                var $img = $(this);

                // Update main displayed image
                $('#main-product-img-@Model.Id')
                    .attr('src', $img.data('defaultsize'))
                    .attr('alt', $img.attr('alt'))
                    .attr('title', $img.attr('title'));

                // Update lightbox anchor target
                $(anchorSel)
                    .attr('href', $img.data('fullsize'))
                    .attr('title', $img.attr('title'));
            });
        });
    })(jQuery);
</script>
