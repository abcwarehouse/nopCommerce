@model NewsletterBoxModel

<form id="marketingForm" novalidate>
  <input type="email" id="newsletter-email" name="email" placeholder="Email Address" required />
  <input type="tel" id="phone" name="phoneNumber" placeholder="Phone Number"
         pattern="^(\(\d{3}\)|\d{3})[-.\s]?\d{3}[-.\s]?\d{4}$" />
  <button type="submit">Subscribe</button>
</form>

<script>
  document.getElementById("marketingForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const email = document.getElementById("newsletter-email").value.trim();
    const rawPhone = document.getElementById("phone").value.trim();
    const phone = rawPhone.replace(/\D/g, ''); // Digits only

    if (!email) {
      alert("Please enter a valid email.");
      return;
    }

    const subscribeToNewsletter = () => {
      const subscribeProgress = $("#subscribe-loading-progress");
      subscribeProgress.show();
      const postData = {
        subscribe: true,
        email: $("#newsletter-email").val()
      };

      $.ajax({
        cache: false,
        type: "POST",
        url: "@(Url.RouteUrl("SubscribeNewsletter"))",
        data: postData,
        success: function (data) {
          $("#newsletter-result-block").html(data.Result);
          if (data.Success) {
            $('#newsletter-subscribe-block').hide();
            $('#newsletter-result-block').show();
            _ltk.Signup.New('newsletter-abc', 'newsletter-email', _ltk.Signup.TYPE.CLICK, 'newsletter-subscribe-button');
          } else {
            $('#newsletter-result-block').fadeIn("slow").delay(2000).fadeOut("slow");
          }
        },
        error: function () {
          alert('Failed to subscribe to newsletter.');
        },
        complete: function () {
          subscribeProgress.hide();
        }
      });
    };

    const subscribeToSms = async () => {
      if (phone.length !== 10) {
        alert("Please enter a valid 10-digit phone number.");
        return;
      }

      try {
        const response = await fetch('/api/marketingSms/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ emailAddress: email, phoneNumber: phone })
        });

        const result = await response.json();
        alert(result.message || "SMS subscription successful.");
      } catch (error) {
        alert("Failed to subscribe to SMS.");
      }
    };

    subscribeToNewsletter();
    if (phone.length > 0) {
      await subscribeToSms();
    }
  });

  $(document).ready(function () {
    $("#newsletter-email").on("keydown", function (event) {
      if (event.keyCode == 13) {
        event.preventDefault();
        $("#marketingForm").submit();
        return false;
      }
    });
  });
</script>
