@using Nop.Web.Framework.Infrastructure
@using Nop.Web.Models.Catalog

@model ProductDetailsModel
@{
    Html.AddScriptParts(ResourceLocation.Footer, "~/lib_npm/magnific-popup/jquery.magnific-popup.min.js");
    Html.AddCssFileParts("~/lib_npm/magnific-popup/magnific-popup.css");

    // custom
    Html.AddScriptParts(ResourceLocation.Footer, "~/Plugins/Misc.AbcFrontend/scripts/jquery.jcarousel.min.js");
}

<div class="gallery">
    @await Component.InvokeAsync("Widget", new { widgetZone = PublicWidgetZones.ProductDetailsBeforePictures, additionalData = Model })

    <div class="picture">
        <!-- ALWAYS wrap the main image with an anchor so it can open fullscreen -->
        <a href="@Model.DefaultPictureModel.FullSizeImageUrl"
           title="@Model.DefaultPictureModel.Title"
           id="main-product-img-lightbox-anchor-@Model.Id"
           class="mfp-image">
            <img id="main-product-img-@Model.Id"
                 src="@Model.DefaultPictureModel.ImageUrl"
                 alt="@Model.DefaultPictureModel.AlternateText"
                 title="@Model.DefaultPictureModel.Title" />
        </a>
    </div>

    @if (Model.PictureModels.Count > 1)
    {
        <div class="jcarousel-wrapper">
            <a class="jcarousel-prev"><i class="fas fa-arrow-left"></i></a>

            <div class="jcarousel">
                <ul>
                    @foreach (var picture in Model.PictureModels)
                    {
                        var typeClass = picture.Title?.Contains("video", StringComparison.InvariantCultureIgnoreCase) == true
                            ? "mfp-iframe"
                            : "mfp-image";

                        <li>
                            <a class="jcarousel-item @typeClass"
                               href="@picture.FullSizeImageUrl"
                               title="@picture.Title">
                                <img class="@typeClass"
                                     src="@picture.ThumbImageUrl"
                                     alt="@picture.AlternateText"
                                     title="@picture.Title"
                                     data-defaultsize="@picture.ImageUrl"
                                     data-fullsize="@picture.FullSizeImageUrl" />
                            </a>
                        </li>
                    }
                </ul>
            </div>

            <a class="jcarousel-next"><i class="fas fa-arrow-right"></i></a>
        </div>
    }

    @await Component.InvokeAsync("Widget", new { widgetZone = PublicWidgetZones.ProductDetailsAfterPictures, additionalData = Model })
</div>

<!-- carousel -->
<script>
    $(document).ready(function () {
        // Init carousel
        var $carousel = $('.jcarousel').jcarousel({ wrap: 'circular' });

        $('.jcarousel-prev').jcarouselControl({ target: '-=2', carousel: $carousel });
        $('.jcarousel-next').jcarouselControl({ target: '+=2', carousel: $carousel });

        // --- Magnific Popup: one setup to rule them all ---
        // Images (main image + any image thumbnail)
        $('.gallery').magnificPopup({
            delegate: 'a.mfp-image',
            type: 'image',
            removalDelay: 300,
            gallery: {
                enabled: true,
                navigateByImgClick: true,
                preload: [0, 1],
                tPrev: '@T("Media.MagnificPopup.Previous")',
                tNext: '@T("Media.MagnificPopup.Next")',
                tCounter: '@T("Media.MagnificPopup.Counter")'
            },
            tClose: '@T("Media.MagnificPopup.Close")',
            tLoading: '@T("Media.MagnificPopup.Loading")'
        });

        // Optional videos (if any thumbnails use mfp-iframe)
        $('.gallery').magnificPopup({
            delegate: 'a.mfp-iframe',
            type: 'iframe',
            removalDelay: 300,
            tClose: '@T("Media.MagnificPopup.Close")',
            tLoading: '@T("Media.MagnificPopup.Loading")'
        });

        // --- When a thumbnail is clicked, update the big image + its lightbox href ---
        $(document).on('click', '.jcarousel-item > img', function () {
            var $img = $(this);
            var defaultSrc = $img.attr('data-defaultsize');
            var fullSrc = $img.attr('data-fullsize');
            var title = $img.attr('title');
            var alt = $img.attr('alt');

            $('#main-product-img-@Model.Id')
                .attr('src', defaultSrc)
                .attr('title', title)
                .attr('alt', alt);

            $('#main-product-img-lightbox-anchor-@Model.Id')
                .attr('href', fullSrc)
                .attr('title', title);
        });
    });
</script>

<style>
    /* Visible area of the carousel */
    .jcarousel {
        position: relative;
        overflow: hidden;
        margin: 20px auto;
        width: 200px;
    }

    /* The container of the carousel items */
    .jcarousel ul {
        width: 10000em;
        position: relative;
        list-style: none;
        margin: 0;
        padding: 0;
    }

    /* Each item */
    .jcarousel li {
        float: left;
        width: 100px;
    }

    .jcarousel-nav {
        margin: 0 auto;
        text-align: center;
    }

    .jcarousel-wrapper {
        display: flex;
        align-items: center;
        max-width: 500px;
        margin: 0 auto;
        gap: .5rem;
    }

    @@media screen and (min-width: 475px) {
        .jcarousel { width: 300px; }
    }

    @@media screen and (min-width: 595px) {
        .jcarousel { width: 400px; }
    }

    @@media screen and (min-width: 769px) {
        .jcarousel { width: 200px; }
    }

    @@media screen and (min-width: 1001px) {
        .jcarousel { width: 300px; }
    }
</style>
