@using Nop.Web.Framework
@using Nop.Core
@using Nop.Core.Infrastructure
@using Nop.Web.Framework.Infrastructure

@inject IWebHelper webHelper

@{
    var storeUrl = webHelper.GetStoreLocation(); 
    var searchBaseUrl = $"{storeUrl}searchspring/results?q=";
}

<script src="https://cdn.searchspring.net/intellisuggest/is.min.js" async defer></script>

<div class="search-container" style="position: relative;">
    <form id="searchForm" autocomplete="off">
        <input type="text" id="searchInput" placeholder="Type to search..." />
        <button type="submit">Search</button>
    </form>
    <div id="autocomplete-results" class="autocomplete-list"></div>
</div>

<style>
    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        z-index: 999;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Added for better visibility */
    }

    .suggestion-item {
        padding: 8px 10px;
        cursor: pointer;
    }

    .suggestion-item:hover {
        background-color: #f0f0f0;
    }
</style>

<script>
    const input = document.getElementById('searchInput');
    const resultsContainer = document.getElementById('autocomplete-results');
    const baseUrl = '@searchBaseUrl';

    window.searchspringTracking = {
        userId: null,
        sessionId: null
    };

    let intellisuggestIsReady = false;

    document.addEventListener('intellisuggest-ready', function () {
        const trackingParams = window.intellisuggest?.getTrackingParams?.();
        if (trackingParams?.userId && trackingParams?.sessionId) {
            window.searchspringTracking.userId = trackingParams.userId;
            window.searchspringTracking.sessionId = trackingParams.sessionId;
            intellisuggestIsReady = true; // Set flag
            console.log("✅ Searchspring tracking ready:", window.searchspringTracking);
        } else {
            console.warn("⚠️ Tracking params missing after intellisuggest-ready event.");
        }
    });

    input.addEventListener('input', async function () {
        const query = input.value.trim();
        if (query.length < 2) {
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            return;
        }

        let userId = window.searchspringTracking.userId;
        let sessionId = window.searchspringTracking.sessionId;

        const suggestUrl = `/searchspring/suggest?q=${encodeURIComponent(query)}${userId && sessionId ? `&userId=${userId}&sessionId=${sessionId}` : ''}`;
        const autocompleteUrl = `/searchspring/autocomplete?q=${encodeURIComponent(query)}${userId && sessionId ? `&userId=${userId}&sessionId=${sessionId}` : ''}`;

        try {
            const [suggestRes, autoRes] = await Promise.all([
                fetch(suggestUrl),
                fetch(autocompleteUrl)
            ]);

            const suggestData = suggestRes.ok ? await suggestRes.json() : null;
            const autocompleteData = autoRes.ok ? await autoRes.json() : null;

            const suggestions = suggestData?.suggestions || [];
            const autocompleteItems = autocompleteData?.results?.[0]?.suggestions || [];

            resultsContainer.innerHTML = '';

            if (suggestions.length > 0) {
                const header = document.createElement('div');
                header.className = 'suggestion-section-header';
                header.textContent = 'Suggested Searches';
                resultsContainer.appendChild(header);

                suggestions.forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = s.value;
                    item.addEventListener('click', () => {
                        input.value = s.value;
                        window.location.href = baseUrl + encodeURIComponent(s.value);
                    });
                    resultsContainer.appendChild(item);
                });
            }

            autocompleteItems.forEach(a => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                
                // Example with image and label
                item.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <img src="${a.thumbnailUrl || '/path/to/fallback.jpg'}" alt="" style="width: 40px; height: 40px; object-fit: contain; margin-right: 10px;" />
                        <span>${a.value}</span>
                    </div>
                `;

                item.addEventListener('click', () => {
                    input.value = a.value;
                    window.location.href = baseUrl + encodeURIComponent(a.value);
                });

                resultsContainer.appendChild(item);
            });

            }

            resultsContainer.style.display = (suggestions.length || autocompleteItems.length) ? 'block' : 'none';

        } catch (err) {
            console.error("❌ Failed to fetch autocomplete/suggest:", err);
            resultsContainer.style.display = 'none';
        }
    });



    // Handle search form submission
    document.getElementById('searchForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const query = input.value.trim();
        if (query) {
            window.location.href = baseUrl + encodeURIComponent(query);
        }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function (event) {
        // Check if the click was outside the search container and not on the input itself
        if (!event.target.closest('.search-container') && event.target !== input) {
            resultsContainer.style.display = 'none';
        }
    });

    input.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            resultsContainer.style.display = 'none';
            input.blur(); // Remove focus from input
        }
    });

</script>